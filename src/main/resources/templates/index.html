<!doctype html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Book Manager</title>

    <!-- â˜…CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’JSç”¨ã«metaã«åŸ‹ã‚è¾¼ã‚€ -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 24px; }
        .pointer { cursor: pointer; }
        .table thead th { white-space: nowrap; }
        .modal input { width: 100%; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">ğŸ“š Book Manager</h1>

    <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ï¼ˆCSRFä»˜ãï¼‰ -->
    <form th:action="@{/logout}" method="post" class="mb-3 text-end">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="btn btn-outline-secondary btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </form>

    <!-- æ“ä½œç”¨ãƒ˜ãƒƒãƒ€ -->
    <div class="row g-2 align-items-end mb-3">
        <div class="col-sm-4">
            <label class="form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰</label>
            <input id="q" type="text" class="form-control" placeholder="ä¾‹: java">
        </div>
        <div class="col-sm-2">
            <label class="form-label">ä»¶æ•°</label>
            <select id="size" class="form-select">
                <option>5</option><option selected>10</option><option>20</option><option>50</option>
            </select>
        </div>
        <div class="col-sm-3">
            <label class="form-label">ä¸¦ã³é †</label>
            <select id="sort" class="form-select">
                <option value="createdAt,desc">ä½œæˆæ—¥ â†“</option>
                <option value="createdAt,asc">ä½œæˆæ—¥ â†‘</option>
                <option value="title,asc">ã‚¿ã‚¤ãƒˆãƒ« Aâ†’Z</option>
                <option value="title,desc">ã‚¿ã‚¤ãƒˆãƒ« Zâ†’A</option>
                <option value="price,asc">ä¾¡æ ¼ å®‰â†’é«˜</option>
                <option value="price,desc">ä¾¡æ ¼ é«˜â†’å®‰</option>
            </select>
        </div>
        <div class="col-sm-3 text-end">
            <button id="btnSearch" class="btn btn-primary me-2">æ¤œç´¢ / æ›´æ–°</button>
            <button id="btnNew" class="btn btn-success">æ–°è¦ç™»éŒ²</button>
        </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="msg" class="alert d-none" role="alert"></div>

    <!-- ä¸€è¦§ -->
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
            <tr>
                <th>ID</th>
                <th class="pointer" data-sort="title">ã‚¿ã‚¤ãƒˆãƒ«</th>
                <th>è‘—è€…</th>
                <th class="pointer" data-sort="price">ä¾¡æ ¼</th>
                <th>ä½œæˆæ—¥</th>
                <th>æ›´æ–°æ—¥</th>
                <th>æ“ä½œ</th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒ³ã‚° -->
    <nav>
        <ul id="pager" class="pagination justify-content-center"></ul>
    </nav>
</div>

<!-- ç™»éŒ²/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="editForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">æ–°è¦ç™»éŒ²</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bookId">
                <div class="mb-3">
                    <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« <span class="text-danger">*</span></label>
                    <input id="title" class="form-control" maxlength="120" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">è‘—è€… <span class="text-danger">*</span></label>
                    <input id="author" class="form-control" maxlength="80" required>
                </div>
                <div class="mb-1">
                    <label class="form-label">ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                    <input id="price" type="number" min="0" step="1" class="form-control">
                </div>
                <div class="form-text">* ã¯å¿…é ˆ</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                <button id="btnSave" type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
      // â˜…CSRFæƒ…å ±ï¼ˆmetaã‹ã‚‰å–å¾—ï¼‰
      const csrfToken  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

      // CSRFãƒ˜ãƒƒãƒ€ã‚’ä»˜ã‘ãŸ headers ã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼
      function authHeaders(extra = {}) {
        const headers = { ...extra };
        if (csrfToken && csrfHeader) {
          headers[csrfHeader] = csrfToken;
        }
        return headers;
      }

      // ç”»é¢çŠ¶æ…‹
      let state = { page: 0, size: 10, sort: 'createdAt,desc', q: '' };

      // â† ã“ã“ã§åˆã‚ã¦è¦ç´ ã‚’å–å¾—ã™ã‚‹ï¼ˆDOM æ§‹ç¯‰å¾Œãªã®ã§ null ã«ãªã‚‰ãªã„ï¼‰
      const tbody = document.getElementById('tbody');
      const pager = document.getElementById('pager');
      const msg   = document.getElementById('msg');

      function showMsg(text, type='info'){ msg.className=`alert alert-${type}`; msg.textContent=text; msg.classList.remove('d-none'); setTimeout(()=>msg.classList.add('d-none'),2500); }
      function fmtDate(s){ if(!s) return ''; try{ return new Date(s).toLocaleString(); }catch{ return s; } }

      async function load(){
        const params = new URLSearchParams();
        if (state.q) params.set('q', state.q);
        params.set('page', state.page); params.set('size', state.size); params.set('sort', state.sort);
        const res = await fetch(`/api/books?${params}`);
        if(!res.ok){ showMsg(`ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status})`, 'danger'); return; }
        const data = await res.json();
        renderTable(data.content || []);
        renderPager(data.number ?? state.page, data.totalPages ?? 1);
      }

      function renderTable(rows){
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.id ?? ''}</td>
            <td>${escapeHtml(r.title ?? '')}</td>
            <td>${escapeHtml(r.author ?? '')}</td>
            <td class="text-end">${r.price ?? ''}</td>
            <td>${fmtDate(r.createdAt)}</td>
            <td>${fmtDate(r.updatedAt)}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="openEdit(${r.id}, '${attr(r.title)}', '${attr(r.author)}', ${r.price ?? 'null'})">ç·¨é›†</button>
              <button class="btn btn-sm btn-outline-danger" onclick="removeBook(${r.id})">å‰Šé™¤</button>
            </td>
          </tr>
        `).join('');
      }

      function renderPager(current, totalPages){
        pager.innerHTML = '';
        const ul = pager;
        function li(disabled, active, label, page){
          const li = document.createElement('li'); li.className='page-item'+(disabled?' disabled':'')+(active?' active':'');
          const a = document.createElement('a'); a.className='page-link'; a.href='#'; a.textContent=label;
          a.onclick = e=>{ e.preventDefault(); if(!disabled){ state.page=page; load(); } };
          li.appendChild(a); ul.appendChild(li);
        }
        li(current===0,false,'Â«',0); li(current===0,false,'â€¹',Math.max(0,current-1));
        const w=3, start=Math.max(0,current-w), end=Math.min(totalPages-1,current+w);
        for(let p=start;p<=end;p++) li(false,p===current,(p+1).toString(),p);
        li(current>=totalPages-1,false,'â€º',Math.min(totalPages-1,current+1));
        li(current>=totalPages-1,false,'Â»',totalPages-1);
      }

      // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯é…å»¶ç”Ÿæˆ ---
      let editModal;
      function ensureModal(){
        if(!editModal){
          const el = document.getElementById('editModal');
          editModal = new bootstrap.Modal(el); // â† æ–‡å­—åˆ—ã§ã¯ãªãè¦ç´ ã‚’æ¸¡ã™
        }
      }

      document.getElementById('btnNew').addEventListener('click', () => openEdit());

      window.openEdit = function(id=null, title='', author='', price=''){
        ensureModal();
        document.getElementById('modalTitle').textContent = id ? `ç·¨é›† #${id}` : 'æ–°è¦ç™»éŒ²';
        document.getElementById('bookId').value = id ?? '';
        document.getElementById('title').value = title ?? '';
        document.getElementById('author').value = author ?? '';
        document.getElementById('price').value = (price ?? '') === null ? '' : (price ?? '');
        editModal.show();
      }

      document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('bookId').value.trim();
        const payload = { title: val('title'), author: val('author'), price: numOrNull('price') };
        if(!payload.title || !payload.author){ showMsg('ã‚¿ã‚¤ãƒˆãƒ«ã¨è‘—è€…ã¯å¿…é ˆã§ã™', 'warning'); return; }
        const res = await fetch(id?`/api/books/${id}`:'/api/books', {
          method: id?'PATCH':'POST',
          headers: authHeaders({'Content-Type':'application/json'}),
          body: JSON.stringify(payload)
        });
        if(res.ok){ ensureModal(); editModal.hide(); showMsg('ä¿å­˜ã—ã¾ã—ãŸ','success'); load(); }
        else{ let m=`ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status})`; try{const j=await res.json(); if(j.message) m+=`: ${j.message}`; if(j.errors) m+=' '+JSON.stringify(j.errors);}catch{}; showMsg(m,'danger'); }
      });

      window.removeBook = async function(id){
        if(!confirm(`ID=${id} ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
        const res = await fetch(`/api/books/${id}`, {
          method:'DELETE',
          headers: authHeaders()
        });
        if(res.ok){ showMsg('å‰Šé™¤ã—ã¾ã—ãŸ','success'); if(tbody.children.length===1 && state.page>0) state.page--; load(); }
        else { showMsg(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status})`, 'danger'); }
      }

      document.querySelectorAll('th.pointer').forEach(th=>{
        th.addEventListener('click', ()=>{
          const key = th.dataset.sort; const [curKey,curDir]=state.sort.split(',');
          const dir = (curKey===key && curDir==='asc')?'desc':'asc';
          state.sort = `${key},${dir}`; state.page=0; load();
        });
      });

      document.getElementById('btnSearch').addEventListener('click', ()=>{
        state.q = document.getElementById('q').value.trim();
        state.size = parseInt(document.getElementById('size').value,10);
        state.sort = document.getElementById('sort').value;
        state.page = 0; load();
      });

      function val(id){ return document.getElementById(id).value.trim(); }
      function numOrNull(id){ const v=document.getElementById(id).value.trim(); if(v==='') return null; const n=Number(v); return Number.isFinite(n)&&n>=0?n:null; }
      function escapeHtml(s){ return (s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function attr(s){ return (s??'').replace(/['"\\]/g,m=>'\\'+m); }

      // åˆæœŸè¡¨ç¤º
      (function init(){
        document.getElementById('size').value=String(state.size);
        document.getElementById('sort').value=state.sort;
        load();
      })();
    }); // DOMContentLoaded
</script>

</body>
</html>
